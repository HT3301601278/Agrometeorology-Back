## 天气服务功能详细说明

系统通过OpenWeatherMap API获取各类气象数据，并进行缓存处理，提供三个主要接口：

### 1. 获取实时天气数据

**API路径**：`/api/weather/current`

**请求方法**：POST

**请求体格式 (JSON)**：
```json
{
  "latitude": 39.9042,     // 纬度
  "longitude": 116.4074,   // 经度
  "fieldId": 1,            // 可选，关联的地块ID
  "units": "metric",       // 可选，单位系统：metric(摄氏度)，imperial(华氏度)
  "lang": "zh_cn"          // 可选，语言：zh_cn(中文)，en(英文)等
}
```

**响应格式**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "dt": 1689234567,                  // 数据时间戳
    "temp": 29.5,                      // 温度
    "feelsLike": 30.2,                 // 体感温度
    "tempMin": 27.8,                   // 最低温度
    "tempMax": 31.2,                   // 最高温度
    "pressure": 1013,                  // 气压(hPa)
    "humidity": 65,                    // 湿度(%)
    "windSpeed": 2.5,                  // 风速(m/s)
    "windDeg": 180,                    // 风向(度)
    "windGust": 3.1,                   // 阵风速度
    "cloudsAll": 25,                   // 云量(%)
    "visibility": 10000,               // 能见度(米)
    "rain1h": 0.0,                     // 过去1小时降雨量(mm)
    "snow1h": 0.0,                     // 过去1小时降雪量(mm)
    "weatherId": 801,                  // 天气状况ID
    "weatherMain": "Clouds",           // 天气主要状况
    "weatherDescription": "少云",      // 天气描述
    "weatherIcon": "02d",              // 天气图标代码
    "locationName": "北京",            // 位置名称
    "latitude": 39.9042,               // 纬度
    "longitude": 116.4074              // 经度
  }
}
```

**实现逻辑**：
- 先从数据库查询是否有30分钟内的缓存数据
- 如果有，直接返回缓存数据
- 如果没有或已过期，调用OpenWeatherMap API获取最新数据并保存到数据库

### 2. 获取天气预报

**API路径**：`/api/weather/forecast`

**请求方法**：POST

**请求体格式 (JSON)**：
```json
{
  "latitude": 39.9042,     // 纬度
  "longitude": 116.4074,   // 经度
  "fieldId": 1,            // 可选，关联的地块ID
  "startTime": 1689234567, // 可选，开始时间戳
  "endTime": 1689839367,   // 可选，结束时间戳
  "units": "metric",       // 可选，单位系统
  "lang": "zh_cn"          // 可选，语言
}
```

**响应格式**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "dt": 1689234567,                  // 数据时间戳
      "forecastType": 1,                 // 预报类型：1=小时级，2=日级，3=气候级
      "temp": 29.5,                      // 温度
      "feelsLike": 30.2,                 // 体感温度
      "tempMin": 27.8,                   // 最低温度
      "tempMax": 31.2,                   // 最高温度
      "pressure": 1013,                  // 气压(hPa)
      "humidity": 65,                    // 湿度(%)
      "windSpeed": 2.5,                  // 风速(m/s)
      "windDeg": 180,                    // 风向(度)
      "windGust": 3.1,                   // 阵风速度
      "cloudsAll": 25,                   // 云量(%)
      "visibility": 10000,               // 能见度(米)
      "pop": 0.2,                        // 降水概率
      "rain3h": 0.0,                     // 3小时降雨量(mm)
      "snow3h": 0.0,                     // 3小时降雪量(mm)
      "weatherId": 801,                  // 天气状况ID
      "weatherMain": "Clouds",           // 天气主要状况
      "weatherDescription": "少云",      // 天气描述
      "weatherIcon": "02d",              // 天气图标代码
      "dtTxt": "2023-07-13 12:00:00"    // 可读的日期时间文本
    },
    // ...更多数据
  ]
}
```

**实现逻辑**：
- 根据请求的时间范围动态调用不同的天气预报API：
  - 0-4天：使用小时级预报
  - 4-16天：使用16天预报
  - 16-30天：使用气候预报
- 数据会被保存到数据库作为缓存

### 3. 获取历史天气数据

**API路径**：`/api/weather/historical`

**请求方法**：POST

**请求体格式 (JSON)**：
```json
{
  "latitude": 39.9042,     // 纬度
  "longitude": 116.4074,   // 经度
  "fieldId": 1,            // 可选，关联的地块ID
  "startTime": 1686642567, // 必填，开始时间戳
  "endTime": 1689234567,   // 必填，结束时间戳
  "units": "metric",       // 可选，单位系统
  "lang": "zh_cn"          // 可选，语言
}
```

**响应格式**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "dt": 1686642567,                  // 数据时间戳
      "temp": 27.2,                      // 温度
      "feelsLike": 28.5,                 // 体感温度
      "pressure": 1012,                  // 气压(hPa)
      "humidity": 68,                    // 湿度(%)
      "tempMin": 25.6,                   // 最低温度
      "tempMax": 29.3,                   // 最高温度
      "windSpeed": 3.2,                  // 风速(m/s)
      "windDeg": 160,                    // 风向(度)
      "cloudsAll": 30,                   // 云量(%)
      "rain1h": 0.5,                     // 1小时降雨量(mm)
      "rain3h": 1.2,                     // 3小时降雨量(mm)
      "snow1h": 0.0,                     // 1小时降雪量(mm)
      "snow3h": 0.0,                     // 3小时降雪量(mm)
      "weatherId": 500,                  // 天气状况ID
      "weatherMain": "Rain",             // 天气主要状况
      "weatherDescription": "小雨",      // 天气描述
      "weatherIcon": "10d",              // 天气图标代码
      "dtTxt": "2023-06-13 15:00:00"    // 可读的日期时间文本
    },
    // ...更多数据
  ]
}
```

**实现逻辑**：
- 先检查数据库中是否有超过90%完整度的历史数据
- 如果有，直接从数据库返回
- 如果没有或数据不完整，调用OpenWeatherMap历史天气API获取数据并保存到数据库