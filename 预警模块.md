# 预警模块

基础URL: `http://localhost:8080/api/alerts`

## 1. 预警规则管理

### 1.1 创建预警规则
- **URL**: `/rules`
- **方法**: POST
- **描述**: 创建新的预警规则
- **请求体**:
```json
{
  "name": "高温预警",
  "type": 1,
  "subType": 1,
  "paramName": "tempMax",
  "operator": ">=",
  "threshold": 35,
  "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。"
}
```
- **响应**:
```json
{
  "code": 200,
  "message": "预警规则创建成功",
  "data": {
    "id": 1,
    "name": "高温预警",
    "type": 1,
    "subType": 1,
    "paramName": "tempMax",
    "operator": ">=",
    "threshold": 35,
    "paramName2": null,
    "operator2": null,
    "threshold2": null,
    "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。",
    "enabled": true,
    "createdAt": "2023-07-01T10:00:00",
    "updatedAt": "2023-07-01T10:00:00"
  }
}
```

### 1.2 更新预警规则
- **URL**: `/rules/{ruleId}`
- **方法**: PUT
- **描述**: 更新现有的预警规则
- **请求体**:
```json
{
  "name": "高温预警(修改)",
  "type": 1,
  "subType": 1,
  "paramName": "tempMax",
  "operator": ">=",
  "threshold": 36,
  "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。"
}
```
- **响应**:
```json
{
  "code": 200,
  "message": "预警规则更新成功",
  "data": {
    "id": 1,
    "name": "高温预警(修改)",
    "type": 1,
    "subType": 1,
    "paramName": "tempMax",
    "operator": ">=",
    "threshold": 36,
    "paramName2": null,
    "operator2": null,
    "threshold2": null,
    "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。",
    "enabled": true,
    "createdAt": "2023-07-01T10:00:00",
    "updatedAt": "2023-07-01T11:30:00"
  }
}
```

### 1.3 删除预警规则
- **URL**: `/rules/{ruleId}`
- **方法**: DELETE
- **描述**: 删除预警规则
- **响应**:
```json
{
  "code": 200,
  "message": "预警规则删除成功",
  "data": null
}
```

### 1.4 启用/禁用预警规则
- **URL**: `/rules/{ruleId}/status`
- **方法**: PATCH
- **描述**: 启用或禁用预警规则
- **请求体**:
```json
{
  "enabled": false
}
```
- **响应**:
```json
{
  "code": 200,
  "message": "预警规则已禁用",
  "data": {
    "id": 1,
    "name": "高温预警",
    "type": 1,
    "subType": 1,
    "paramName": "tempMax",
    "operator": ">=",
    "threshold": 35,
    "paramName2": null,
    "operator2": null,
    "threshold2": null,
    "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。",
    "enabled": false,
    "createdAt": "2023-07-01T10:00:00",
    "updatedAt": "2023-07-01T12:00:00"
  }
}
```

### 1.5 获取预警规则详情
- **URL**: `/rules/{ruleId}`
- **方法**: GET
- **描述**: 获取特定预警规则的详细信息
- **响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "name": "高温预警",
    "type": 1,
    "subType": 1,
    "paramName": "tempMax",
    "operator": ">=",
    "threshold": 35,
    "paramName2": null,
    "operator2": null,
    "threshold2": null,
    "message": "地块[{field}]预计在{date}出现高温天气，最高温度预计达到{value}℃，请注意防范高温对作物的影响。",
    "enabled": true,
    "createdAt": "2023-07-01T10:00:00",
    "updatedAt": "2023-07-01T10:00:00"
  }
}
```

### 1.6 获取所有预警规则
- **URL**: `/rules`
- **方法**: GET
- **描述**: 分页获取所有预警规则
- **参数**:
  - page: 页码(默认0)
  - size: 每页条数(默认20)
  - sort: 排序字段(默认id,desc)
- **响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "content": [
      {
        "id": 12,
        "name": "低能见度预警",
        "type": 6,
        "subType": 2,
        "paramName": "visibility",
        "operator": "<=",
        "threshold": 2000,
        "paramName2": null,
        "operator2": null,
        "threshold2": null,
        "message": "地块[{field}]预计在{date}能见度较低({value}m)，请注意作业安全。",
        "enabled": true,
        "createdAt": "2023-07-01T10:00:00",
        "updatedAt": "2023-07-01T10:00:00"
      },
      {
        "id": 11,
        "name": "气压快速下降预警",
        "type": 6,
        "subType": 1,
        "paramName": "pressure",
        "operator": "<=",
        "threshold": 1005,
        "paramName2": null,
        "operator2": null,
        "threshold2": null,
        "message": "地块[{field}]预计在{date}气压较低({value}hPa)，可能有恶劣天气，请密切关注天气变化。",
        "enabled": true,
        "createdAt": "2023-07-01T10:00:00",
        "updatedAt": "2023-07-01T10:00:00"
      }
    ],
    "pageable": {
      "sort": {
        "sorted": true,
        "unsorted": false,
        "empty": false
      },
      "pageNumber": 0,
      "pageSize": 20,
      "offset": 0,
      "paged": true,
      "unpaged": false
    },
    "totalPages": 1,
    "totalElements": 12,
    "last": true,
    "first": true,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    },
    "numberOfElements": 12,
    "size": 20,
    "number": 0,
    "empty": false
  }
}
```

## 2. 预警记录管理

### 2.1 获取所有预警记录
- **URL**: `/records`
- **方法**: GET
- **描述**: 分页获取所有预警记录
- **参数**:
  - page: 页码(默认0)
  - size: 每页条数(默认20)
  - sort: 排序字段(默认createdAt,desc)
- **响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "content": [
      {
        "id": 2,
        "ruleId": 7,
        "ruleName": "病害风险预警",
        "ruleType": 3,
        "ruleSubType": 3,
        "forecastDt": 1747392000,
        "paramValue": 92,
        "paramValue2": 0.78,
        "message": "地块[测试农场1号]预计在2025-04-26 12:00:00出现高湿度(92%)且降水概率较高(0.78)的情况，病害风险增加，建议提前采取防护措施。",
        "forecastDate": "2025-04-26 12:00:00",
        "latitude": 39.9042,
        "longitude": 116.4074,
        "createdAt": "2023-07-02T09:30:00"
      },
      {
        "id": 1,
        "ruleId": 1,
        "ruleName": "高温预警",
        "ruleType": 1,
        "ruleSubType": 1,
        "forecastDt": 1745380800,
        "paramValue": 36.5,
        "paramValue2": null,
        "message": "地块[测试农场1号]预计在2025-04-23 12:00:00出现高温天气，最高温度预计达到36.5℃，请注意防范高温对作物的影响。",
        "forecastDate": "2025-04-23 12:00:00",
        "latitude": 39.9042,
        "longitude": 116.4074,
        "createdAt": "2023-07-02T09:30:00"
      }
    ],
    "pageable": {
      "sort": {
        "sorted": true,
        "unsorted": false,
        "empty": false
      },
      "pageNumber": 0,
      "pageSize": 20,
      "offset": 0,
      "paged": true,
      "unpaged": false
    },
    "totalPages": 1,
    "totalElements": 2,
    "last": true,
    "first": true,
    "sort": {
      "sorted": true,
      "unsorted": false,
      "empty": false
    },
    "numberOfElements": 2,
    "size": 20,
    "number": 0,
    "empty": false
  }
}
```

### 2.2 获取预警记录详情
- **URL**: `/records/{recordId}`
- **方法**: GET
- **描述**: 获取特定预警记录的详细信息
- **响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "ruleId": 1,
    "ruleName": "高温预警",
    "ruleType": 1,
    "ruleSubType": 1,
    "forecastDt": 1745380800,
    "paramValue": 36.5,
    "paramValue2": null,
    "message": "地块[测试农场1号]预计在2025-04-23 12:00:00出现高温天气，最高温度预计达到36.5℃，请注意防范高温对作物的影响。",
    "forecastDate": "2025-04-23 12:00:00",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "createdAt": "2023-07-02T09:30:00"
  }
}
```

### 2.3 获取最近7天的预警记录
- **URL**: `/records/recent`
- **方法**: GET
- **描述**: 获取最近7天内的所有预警记录
- **响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 2,
      "ruleId": 7,
      "ruleName": "病害风险预警",
      "ruleType": 3,
      "ruleSubType": 3,
      "forecastDt": 1747392000,
      "paramValue": 92,
      "paramValue2": 0.78,
      "message": "地块[测试农场1号]预计在2025-04-26 12:00:00出现高湿度(92%)且降水概率较高(0.78)的情况，病害风险增加，建议提前采取防护措施。",
      "forecastDate": "2025-04-26 12:00:00",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "createdAt": "2023-07-02T09:30:00"
    },
    {
      "id": 1,
      "ruleId": 1,
      "ruleName": "高温预警",
      "ruleType": 1,
      "ruleSubType": 1,
      "forecastDt": 1745380800,
      "paramValue": 36.5,
      "paramValue2": null,
      "message": "地块[测试农场1号]预计在2025-04-23 12:00:00出现高温天气，最高温度预计达到36.5℃，请注意防范高温对作物的影响。",
      "forecastDate": "2025-04-23 12:00:00",
      "latitude": 39.9042,
      "longitude": 116.4074,
      "createdAt": "2023-07-02T09:30:00"
    }
  ]
}
```

## 3. 预警检查

### 3.1 手动触发预警检查
- **URL**: `/check`
- **方法**: POST
- **描述**: 手动触发预警规则与天气预报数据的检查，生成预警记录
- **响应**:
```json
{
  "code": 200,
  "message": "预警检查已触发",
  "data": null
}
```

## 4. 预警规则类型说明

### 4.1 规则类型(type)
- 1: 温度类预警
- 2: 湿度与蒸腾压差预警
- 3: 降水与病害预警
- 4: 风害预警
- 5: 日照与光照预警
- 6: 气压/能见度预警

### 4.2 规则子类型(subType)
根据主类型不同，子类型含义不同：

**温度类(type=1)**
- 1: 高温预警
- 2: 低温/霜冻预警

**湿度类(type=2)**
- 1: 低湿度预警
- 2: 高蒸汽压亏缺(VPD)预警

**降水类(type=3)**
- 1: 降水概率预警
- 2: 强降水量预警
- 3: 病害高风险期预警

**风害类(type=4)**
- 1: 大风预警

**光照类(type=5)**
- 1: 光照不足预警
- 2: 昼长过短预警

**气压/能见度类(type=6)**
- 1: 低压快速下降预警
- 2: 低能见度预警

### 4.3 可用气象参数(paramName)
- temp: 温度(℃)
- feelsLike: 体感温度(℃)
- tempMin: 最低温度(℃)
- tempMax: 最高温度(℃)
- pressure: 气压(hPa)
- humidity: 相对湿度(%)
- windSpeed: 风速(m/s)
- windDeg: 风向(度)
- windGust: 阵风风速(m/s)
- cloudsAll: 云量(%)
- visibility: 能见度(m)
- pop: 降水概率(0-1)
- rain1h: 1小时降雨量(mm)
- snow1h: 1小时降雪量(mm)
- dayLength: 日长(小时，根据sunrise和sunset计算)
- vpd: 蒸汽压亏缺(kPa，根据温度和湿度计算)

### 4.4 可用运算符(operator)
- \>: 大于
- \>=: 大于等于
- <: 小于
- <=: 小于等于
- ==: 等于